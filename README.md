# MixedPrecisionNanny

混合精度训练保姆——深度学习FP16/BF16训练问题诊断工具。

## 项目背景

在深度学习训练过程中，混合精度训练（FP16/BF16）是提高训练效率的重要手段，但往往会面临精度下降（"掉点"）的问题。根据业务影响程度，我们将掉点分为两类：

| 类型 | 描述 | 业务可接受性 |
|------|------|-------------|
| **类型1：轻微掉点** | 由数值精度差异导致的模型精度轻微下降 | ✅ 可接受，可业务使用 |
| **类型2：显著掉点** | 训练崩溃、精度显著下降，不符合预期 | ❌ 不可接受 |

从业务角度出发，我们的目标是：**最大化类型1的发生，最小化甚至消除类型2的发生**。

为此，我们需要一套完整的工具和方法论来预防和诊断类型2的问题。

## 核心功能

MixedPrecisionNanny 旨在通过以下三个核心功能模块，帮助业务团队在混合精度训练前、中、后全链路保障训练稳定性：

### a. 静态代码检查（训练前预防）

在训练开始前，对模型代码进行静态分析，提前识别潜在的数值风险点：

- **溢出敏感算子检测**：识别在 FP16/BF16 下容易发生数值溢出或下溢的算子
- **异常值风险分析**：检测可能导致 NaN/Inf 的运算模式
- **最佳实践建议**：提供针对性的代码改进建议

**典型检测场景**：
- Softmax、LayerNorm、CrossEntropy 等易溢出算子
- 梯度缩放（Gradient Scaling）配置检查
- Loss Scaling 策略合理性验证

### b. 轻量化梯度监控（训练中观测）

在训练过程中，以轻量化的方式实时监控模型状态，捕捉异常信号：

- **梯度统计监控**：实时跟踪梯度范数、梯度分布
- **数值异常告警**：及时检测 NaN/Inf、异常大/小梯度
- **层级粒度追踪**：支持模型各层的细粒度监控
- **低性能开销**：确保监控本身不影响训练效率

### c. 可视化分析界面（训练后诊断）

提供直观的可视化工具，帮助业务人员深入分析训练过程中的数值行为：

- **训练曲线可视化**：Loss、梯度范数、学习率等关键指标
- **数值分布热力图**：各层激活值、权重的数值分布变化
- **异常时刻定位**：快速定位异常发生的时间点和位置
- **对比分析**：支持 FP32 与 FP16/BF16 训练的对比

## 工作流程

```
┌─────────────────────────────────────────────────────────────────┐
│                   MixedPrecisionNanny 工作流                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐      │
│  │   训练前检查  │───▶│   训练中监控  │───▶│   训练后分析  │      │
│  │  (StaticCheck)│    │  (Monitoring) │    │  (Visualizer) │      │
│  └──────────────┘    └──────────────┘    └──────────────┘      │
│          │                   │                   │             │
│          ▼                   ▼                   ▼             │
│   ┌────────────┐      ┌────────────┐      ┌────────────┐      │
│   │ 风险算子识别 │      │ 梯度异常告警 │      │ 数值行为分析 │      │
│   │ 代码问题扫描 │      │ 实时统计上报 │      │ 可视化报表   │      │
│   └────────────┘      └────────────┘      └────────────┘      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 项目结构

```
MixedPrecisionNanny/
├── mcp_server/              # P0: 静态代码检查（MCP Server形式）
│   ├── server.py            # MCP Server主程序
│   ├── skills/              # 知识库
│   ├── prompts/             # Agent提示词
│   └── tests/               # 单元测试
├── skills/                  # 知识库（供参考）
│   ├── unsafe_ops/
│   ├── numerical_issues/
│   ├── reduction_patterns/
│   └── common_fixes/
├── docs/                    # 文档
│   ├── functional_requirements_v2.md
│   └── research_survey.md
├── check_model.py           # 极简静态检查脚本
├── monitor_simple.py        # 极简监控脚本
└── README.md
```

## 目标用户

- **算法工程师**：排查混合精度训练中的精度问题
- **训练平台开发者**：集成监控能力到训练框架
- **业务负责人**：评估混合精度训练的风险与收益

## 快速开始

### 方式1：使用MCP Server（推荐）

通过AI Agent进行自然语言交互式的代码检查：

```bash
# 配置MCP Server到Claude Desktop等客户端
# 详见 mcp_server/README.md
```

### 方式2：使用命令行脚本

```bash
# 静态检查
python check_model.py your_model.py

# 监控训练
from monitor_simple import watch_model
watch_model(model)
```

## 技术特点

- **MCP协议支持**：与AI Agent自然语言交互
- **自适应阈值**：根据训练数据自动确定告警阈值
- **零侵入监控**：装饰器方式接入，不改训练代码
- **知识驱动**：基于真实案例的问题诊断

## 贡献指南

欢迎提交 Issue 和 PR，共同完善这个工具。

## License

待定
